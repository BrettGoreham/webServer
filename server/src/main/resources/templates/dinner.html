<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" >
<head>
    <style>
        body {
            padding: 0;
            margin: 0;
            background-color: #28CBFF;
        }
        div {
            font-family: Arial;
        }
        h2 {
            font-family: Arial;
        }

        h3 {
            font-family: Arial;
        }

        textarea {
            resize: none;
        }

        button {font-family: Arial;}

        .alignCenter {
            margin: auto;
            text-align: center;
            vertical-align: middle;
        }

        .flexCenter {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .alignFloatRight {
            float: right;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 25% 25% 25% 25%;
            padding: 10px;
        }
        .grid-item {
            background-color: #83b2f3;
            border: 1px solid rgba(0, 0, 0, 0.8);
            border-radius: 25px;
            margin: 15px;
            padding: 20px;
        }

        .list {
            list-style-type: none;
            display: none;
            margin: 0;
            padding: 0;
        }

        .list-item{
            background-color: #00E1EF;
            height: 25px;
            border-radius: 25px;
            margin-bottom: 10px;
        }

        .disabled{
            background-color: #5a5a5a;
        }


        .select-button {
            border-radius: 15px;
            height: 35px;
            width: auto;
            background-color: #A2F995;
            text-align: center;
            display: inline-block;

            font-size: 20px;
        }

        .hide-button {
            background-color: #83b2f3;
            border: 1px solid rgba(0, 0, 0, 0.8);;
            color: white;

            height: 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 12px;
            border-radius: 40px;
        }
        .disable-button {
            background-color: #83b2f3;
            border: 1px solid rgba(0, 0, 0, 0.8);;
            color: white;

            text-align: center;
            text-decoration: none;
            font-size: 10px;
            border-radius: 40px;
        }


        /* The Modal (background) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            padding-top: 100px; /* Location of the box */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content */
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        /* The Close Button */
        .close {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .hoverColor:hover {
            background-color: #A2F995;
        }



    </style>
    <title>What Is For Dinner Tonight</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <script type="text/javascript" th:src="@{/js/baseJs.js}"></script>
    <script>

        function startRandomSelection() {
            document.getElementById("start").disabled = true;
            document.getElementById("start").innerHTML = "Finding dinner..."
            reset();

            var allDisabledMealCateogries = document.querySelectorAll( '.grid-item:not(.disabled)' );

            allDisabledMealCateogries = filterCategoriesWithNoOptions(allDisabledMealCateogries);

            if (allDisabledMealCateogries.length > 0) {
                var numberOfRandomSelects = Math.floor(allDisabledMealCateogries.length * 3);

                setTimeoutForSelectedIndex(numberOfRandomSelects, allDisabledMealCateogries, -1)
            }
            else {
                alert("No enabled categories with enabled meal options available :(");
                enableStartButton();
            }


        }

        function filterCategoriesWithNoOptions(listOfGridItems) {
            var filtered = [];
            for (var i = 0; i < listOfGridItems.length; i++) {
                if (listOfGridItems[i].querySelectorAll(".list-item:not(.disabled)").length > 0) {
                    filtered.push(listOfGridItems[i]);
                }
            }

            return filtered;

        }

        function reset() {
            var allMealCateogries = document.querySelectorAll( '.grid-item:not(.disabled)' );
            for (var i = 0; i < allMealCateogries.length; i++) {
                makeElementUnselected(allMealCateogries[i], "#83b2f3");
            }

            var allMealOptions = document.querySelectorAll( '.list-item:not(.disabled)' );
            for (var i = 0; i < allMealOptions.length; i++) {
                makeElementUnselected(allMealOptions[i], "#00E1EF");
            }
        }

        function setTimeoutForSelectedIndex(numberOfRandomLeftSelects, listOfElements, lastSelectedIndex) {

            if (lastSelectedIndex > -1) {
                makeElementUnselected(listOfElements[lastSelectedIndex], '#83b2f3');
            }

            var selected = Math.floor(Math.random() * listOfElements.length);

            if (numberOfRandomLeftSelects == 1) {
                finishMealCategory(listOfElements[selected]);
            }
            else {
                makeElementSelected(listOfElements[selected], '#F9F871');

                var timeout = calculateTimeout(numberOfRandomLeftSelects);

                setTimeout(setTimeoutForSelectedIndex, timeout, numberOfRandomLeftSelects - 1, listOfElements, selected);
            }
        }

        function makeElementSelected(element, color){
            element.style.backgroundColor = color;
        }

        function makeElementUnselected(element, color) {
            if (element) {
               element.style.backgroundColor = color;
            }
        }

        function finishMealCategory(element) {
            makeElementSelected(element, '#3DF1C6')

            var list = element.getElementsByClassName("list")[0];
            list.style.display = "block";

            var hideButton = element.getElementsByClassName("hide-button")[0];
            hideButton.innerHTML = "Hide Meals -";

            startMealOptionSelection(element);
        }

        function startMealOptionSelection(mealCategoryElement) {
            var allMealOptionsInCategory = mealCategoryElement.querySelectorAll( '.list-item:not(.disabled)' );

            if (allMealOptionsInCategory.length > 1) {
                var numberOfRandomSelects = Math.max(Math.floor(Math.random() * allMealOptionsInCategory.length)
                                                + Math.floor(Math.random() * (15 * allMealOptionsInCategory.length)), 5);

                setTimeout(selectMealOptionUntilRandomSelectsAreDone, 200, allMealOptionsInCategory, 0, numberOfRandomSelects);
            }
            else {
                finishMealOption(allMealOptionsInCategory[0]);
            }
        }

        function selectMealOptionUntilRandomSelectsAreDone(listOptions, currentSelectNum, stopSelect) {

            var indexSelected = currentSelectNum % listOptions.length;
            var lastSelected = (currentSelectNum - 1)  % listOptions.length;
            if (lastSelected >= 0){
                makeElementUnselected(listOptions[lastSelected], "#00E1EF");
            }

            if(currentSelectNum == stopSelect) {
                finishMealOption(listOptions[indexSelected]);
            }
            else {
                makeElementSelected(listOptions[indexSelected], '#F9F871');

                var timeout = calculateTimeout(stopSelect - currentSelectNum);
                var nextSelect = currentSelectNum + 1;
                setTimeout(selectMealOptionUntilRandomSelectsAreDone, timeout, listOptions, nextSelect, stopSelect);
            }


        }

        function finishMealOption(finalChosenMeal) {
            finalChosenMeal.style.backgroundColor = "#A2F995";
            enableStartButton();
        }

        function enableStartButton() {
            document.getElementById("start").disabled = false;
            document.getElementById("start").innerHTML = "Try Again?"
        }


        function calculateTimeout(numselectsLeft) {
            var timeout = 100;
            if (numselectsLeft <= 5) {
                timeout = 400
            }
            else if ( numselectsLeft <= 15) {
                timeout = 250;
            }

            return timeout;
        }

        function toggleList(button){
            var divButtonBelongsTo = button.parentNode;
            var list = divButtonBelongsTo.getElementsByClassName("list");

            if (button.innerHTML === "See Meals +") {
                button.innerHTML = "Hide Meals -";
            } else {
                button.innerHTML = "See Meals +";
            }
            toggleHideButton(list[0]);
        }

        function toggleDisable(button) {
            var divButtonBelongsTo = button.parentNode;

            toggleDivAndChangeButtonText(divButtonBelongsTo, button);
        }

        function toggleDisableListItem(listItemButton) {
            var divButtonBelongsTo = listItemButton.parentNode.parentNode;

            toggleDivAndChangeButtonText(divButtonBelongsTo, listItemButton);

        }

        function toggleDivAndChangeButtonText(div, button) {
            div.style.backgroundColor = null;
            div.classList.toggle("disabled");
            if (button.innerHTML === "Disable") {
                button.innerHTML = "Enable";
            } else {
                button.innerHTML = "Disable";
            }
        }

    </script>
</head>
<body>


    <h2  class="alignCenter" style="margin-bottom: 20px; margin-top: 20px; ">
        What Is For Dinner Tonight?
    </h2>

    <div class="alignCenter">
        <button id="start" class="select-button" onclick="startRandomSelection()" >Pick randomly</button>
    </div>


    <div class="grid-container">
        <div class="grid-item"  th:each="category : ${mealCategories}">
            <button class="alignFloatRight disable-button" onclick="toggleDisable(this)">Disable</button>
            <div class="alignCenter" th:text="${category.categoryName}"></div>

            <br/><br/>
            <ul class="list">
                <li class="list-item alignCenter"
                    style="padding-top: 5px; padding-right: 5px"
                    th:each="meal : ${category.mealOptions}">
                    <div>
                        <button class="alignFloatRight disable-button"
                                onclick="toggleDisableListItem(this)"
                                 >Disable</button>
                        <div class="flexCenter"
                             th:text="${meal.getMealName()}"
                             ></div>
                    </div>
                </li>
            </ul>
            <button class="alignFloatRight hide-button" onclick="toggleList(this)">See Meals +</button>
        </div>
    </div>



    <div class="alignCenter" style="margin-bottom: 20px">
        Don't see your favourite meal? <a href="/whatIsForDinner/suggestionsForm">See and add suggestions here</a>
    </div>


    <!-- Trigger/Open The Modal -->
    <div class="flexCenter">
        <div id="myBtn" class="hoverColor" style="padding: 5px; width: fit-content; border-radius: 25px">Have a Complaint or Request? Click here to send feedback.</div>
    </div>

    <!-- The Modal -->
    <div id="myModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content" style="background-color: #28CBFF">
            <span class="close">&times;</span>
            <h3>Email form</h3>
            <form id="emailForm" action="" method="post" onsubmit="ajaxEmailSubmit(this); return false;">
                <label>Your email: </label><input class="formVal" name="email" type="email" required>
                <br/><br/>
                <label>Subject: </label><input class="formVal" name="subject" type="text" required>
                <br/><br/>
                <label>email content:</label><br>
                <textarea class="formVal" name="content" wrap="soft" rows="10" style="width: 95%;"  required></textarea>
                <br/><br/><br/>

                <input type="submit">
            </form>
        </div>

    </div>

    <script>
        // Get the modal
        var modal = document.getElementById("myModal");

        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks the button, open the modal
        btn.onclick = function() {
            modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }



        function ajaxEmailSubmit(form)
        {
            var elements = form.getElementsByClassName("formVal");
            var formData = new FormData();
            for(var i=0; i<elements.length; i++)
            {
                formData.append(elements[i].name, elements[i].value);
            }
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function()
            {
                if(xmlHttp.readyState == 4 && xmlHttp.status == 200)
                {
                    alert(xmlHttp.responseText);
                }
            }
            xmlHttp.open("post", "/emailPost");
            xmlHttp.send(formData);

            modal.style.display = "none";
            form.reset();
        }

    </script>

</body>
</html>